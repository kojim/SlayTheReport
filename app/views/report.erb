<html>
<head>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script>
<% if @is_edit_mode then %>
    var is_edit_mode = true;
<% else %>
    var is_edit_mode = false;
<% end %>
  </script>
  <script>
    $(function(){
      var deck_count = 0;
      var relic_count = 0;
      $('.master_deck input:checked').each(function() {
        $(this).parent().find('img').toggleClass('selected');
        deck_count++;
      });
      $('.master_relic input:checked').each(function() {
        $(this).parent().find('img').toggleClass('selected');
        relic_count++;
      });
      if (is_edit_mode) {
        $('.master_deck img').click(function(e) {
          var input = $(e.target).parent().find('input');
          if (input.prop('checked')) {
            input.prop('checked', false);
            $(e.target).toggleClass('selected');
            deck_count--;
          } else if (deck_count < 3) {
            input.prop('checked', true);
            $(e.target).toggleClass('selected');
            deck_count++;
          }
        });
        $('.master_relic img').click(function(e) {
          var input = $(e.target).parent().find('input');
          if (input.prop('checked')) {
            input.prop('checked', false);
            $(e.target).toggleClass('selected');
            relic_count--;
          } else if (relic_count < 1) {
            input.prop('checked', true);
            $(e.target).toggleClass('selected');
            relic_count++;
          }
        });
      }
    })
  </script>

</head>

<body>
<% require_relative '../image' %>

<div class='header'>
  <header class='title'>SlayTheReport</header>
  <header class='menu'>
    <ul class='pages'>
      <li><a href='/'>トップページ</a></li>
      <% if @twitter != nil then %>
        <li><a href="/mypage">マイページ</a></li>
      <% else %>
        <li><a href="/auth">ログイン</a></li>
      <% end %>
      <li><a href="/help">ヘルプ</a></li>
    </ul>
  </header>
</div>

<% if @is_edit_mode then %>
  <form target='.' method='post'>
<% end %>
<h1>GameInfo</h1>

<% if @is_edit_mode then %>
  <p>タイトル: <input type='text' name='title' maxlength='20' value='<%= h(@report.title) %>' /></p>
<% else %>
  <p>タイトル: <%= h(@report.title) %> 
  <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="<%= h(@report.title) %> by <%= h(@report.author) %>" data-hashtags="SlayTheReport" data-show-count="true">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </p>
<% end %>

<% if @is_edit_mode then %>
  <p>一言説明: <textarea rows='2' cols='60' maxlength='50' name='description'><%= h(@report.description) %></textarea>
<% else %>
  <p>一言説明: <%= h(@report.description) %> </p>
<% end %>

<p>player: <%= h(@report.author) %></p>
<p>runid: <%= h(@report.run_id) %></p>
<p>seed: <%= h(@report.run.seed_text) %></p>
<p>AscensionLevel: <%= h(@report.run.ascension_level) %></p>

<h2>deck(<%=@report.run.master_deck.size%>) </h2>
<div class='master_deck'>
<% @report.run.master_deck.each_with_index do |c,idx| %>
  <span>
  <%= img(c,80) %>
  <input type='checkbox' name='key_card_<%= idx %>' value='<%=c%>' style='display:none' <%= if @report.key_cards_pos.include? idx.to_s then 'checked="checked"' else '' end %>/>
  </span>
<% end %>
</div>
<h2>relics(<%=@report.run.relics.size%>)</h2>
<div class='master_relic'>
<% @report.run.relics.each_with_index do |c,idx| %>
  <span>
  <%= img(c,60) %>
  <input type='checkbox' name='key_relic_<%= idx %>' value="<%=c%>" style='display:none' <%= if @report.key_relics_pos.include? idx.to_s then 'checked="checked"' else '' end %>/>
  </span>
<% end %>
</div>


<h1>Floors</h1>

<% @report.run.floors.each_with_index do |f,idx| %>

  <h2> Floor <%= f.floor_id %> </h2>
  <div class='f_container'>
    <div class='f_events'>
      <div class='f_event_summary'>
        <div class='f_event_image'><%= img(f.image, 250) %></div>
        <div class='f_event_text'></div>
      </div>
      <div class='f_player_action'>
        <div class='f_player_choise'>
          <% if f.player_choise != nil then %>
            行動選択: <%= f.player_choise %>
          <% end %>
        </div>
        <div class='f_life_gold'>
          <%= img('hp', 30) %> <%= f.hp %> / <%= f.max_hp %> (<%= sprintf("%+d", f.hp_diff) %>)
          <%= img('gold', 30) %> <%= f.gold %> (<%= sprintf("%+d", f.gold_diff) %>)
        </div>
        <% f.obtain_chosen_cards.each do |c| %>
          <div class='f_chosen_cards'>
            <% if c['picked'] != 'SKIP' %>
              <div class='picked'>
                <%= img(c['picked'], 80) %>
                <p> picked</p> 
              </div>
            <% end %>
            <% c['not_picked'].each do |np| %>
              <div>
                <%= img(np, 80) %>
                <p> not picked</p> 
              </div>
            <% end %>
            </p>
          </div>
        <% end %>
        <div class='f_obtain_objects'>
          <% f.obtain_objects.each do |c| %>
            <%= img(c, 80) %>
          <% end %>
        </div>
        <% f.upgrade_cards.each do |c| %>
          <div class='f_upgrade_cards'>
            <%= img(c, 80) %>
            ⇒
            <%= img(c+'+1', 80) %>
          </div>
        <% end %>
        <div class='f_remove_cards'>
          <% f.remove_cards.each do |c| %>
            <div class='removed'>
              <%= img(c, 80) %>
              <p> removed</p> 
            </div>
          <% end %>
        </div>
        <div class='f_bottled_cards'>
          <% f.bottled_cards.each do |c| %>
            <div class='bottled'>
              <%= img(c, 80) %>
              <p> bottled</p> 
            </div>
          <% end %>
        </div>
      </div>
    </div>
    <div class='f_comment'>
      <% if @is_edit_mode then %>
        <% if @report.floor_comment[idx] != nil %>
          <textarea rows='3' name='report_<%= format("%03d", idx) %>'><%= h(@report.floor_comment[idx]) %></textarea>
        <% else %>
          <textarea rows='3' name='report_<%= format("%03d", idx) %>'></textarea>
        <% end %>
      <% else %>
        <% if @report.floor_comment[idx] != nil %>
          <p><%= h(@report.floor_comment[idx]) %></p>
        <% else %>
          <p></p>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<% if @is_edit_mode then %>
  <button type='submit'>submit</button>
  </form>
<% end %>
</body>
</html>

